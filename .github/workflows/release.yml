name: Release VSIX

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºrelease
      
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿ç”Ÿæˆchangelog
          
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'kiro-spec/package-lock.json'
          
      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        working-directory: ./kiro-spec
        run: npm ci
        
      - name: è¿è¡Œä»£ç æ£€æŸ¥
        working-directory: ./kiro-spec
        run: |
          npm run lint
          
      - name: ç¼–è¯‘ TypeScript
        working-directory: ./kiro-spec
        run: npm run compile
        
      - name: æå–ç‰ˆæœ¬å·
        id: get_version
        run: |
          # ä»gitæ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          
      - name: éªŒè¯ç‰ˆæœ¬å·ä¸€è‡´æ€§
        working-directory: ./kiro-spec
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if [ "$PACKAGE_VERSION" != "${{ steps.get_version.outputs.version }}" ]; then
            echo "âŒ ç‰ˆæœ¬å·ä¸ä¸€è‡´ï¼"
            echo "Git æ ‡ç­¾ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
            echo "package.json ç‰ˆæœ¬: $PACKAGE_VERSION"
            exit 1
          else
            echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡: $PACKAGE_VERSION"
          fi
          
      - name: ç”Ÿæˆ VSIX æ–‡ä»¶
        working-directory: ./kiro-spec
        run: |
          # å®‰è£… vsce å·¥å…·
          npm install -g @vscode/vsce
          # æ‰“åŒ…ç”Ÿæˆ VSIX
          npm run package
          
      - name: éªŒè¯ VSIX æ–‡ä»¶
        working-directory: ./kiro-spec
        run: |
          VSIX_FILE="kiro-spec-${{ steps.get_version.outputs.version }}.vsix"
          if [ ! -f "$VSIX_FILE" ]; then
            echo "âŒ VSIX æ–‡ä»¶æœªæ‰¾åˆ°: $VSIX_FILE"
            exit 1
          fi
          
          # éªŒè¯VSIXæ–‡ä»¶å®Œæ•´æ€§
          file_size=$(stat -c%s "$VSIX_FILE")
          if [ $file_size -lt 1000 ]; then
            echo "âŒ VSIX æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½æ„å»ºå¤±è´¥"
            exit 1
          fi
          
          echo "âœ… VSIX æ–‡ä»¶éªŒè¯é€šè¿‡: $VSIX_FILE (${file_size} bytes)"
          
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: release_notes
        run: |
          # è·å–æœ€è¿‘çš„ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤è®°å½•
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | sed -n '2p')
          
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## ğŸš€ æ–°åŠŸèƒ½å’Œæ”¹è¿›" >> release_notes.md
            echo "" >> release_notes.md
            git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..${{ steps.get_version.outputs.tag }} >> release_notes.md
            echo "" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          echo "## ğŸ“¦ å®‰è£…æ–¹å¼" >> release_notes.md
          echo "" >> release_notes.md
          echo "1. ä¸‹è½½ \`kiro-spec-${{ steps.get_version.outputs.version }}.vsix\` æ–‡ä»¶" >> release_notes.md
          echo "2. åœ¨ VS Code ä¸­ä½¿ç”¨ \`Extensions: Install from VSIX\` å‘½ä»¤å®‰è£…" >> release_notes.md
          echo "3. æˆ–é€šè¿‡å‘½ä»¤è¡Œå®‰è£…: \`code --install-extension kiro-spec-${{ steps.get_version.outputs.version }}.vsix\`" >> release_notes.md
          
      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: "Kiro Spec v${{ steps.get_version.outputs.version }}"
          body_path: release_notes.md
          files: |
            kiro-spec/kiro-spec-${{ steps.get_version.outputs.version }}.vsix
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: æ„å»ºå®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ VSIX æ„å»ºå’Œå‘å¸ƒæˆåŠŸï¼"
          echo "ğŸ“‹ ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
          echo "ğŸ”— ä¸‹è½½é“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.tag }}"
          
      - name: æ„å»ºå¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ VSIX æ„å»ºæˆ–å‘å¸ƒå¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚"